<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema2To3</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">unison-parser-typechecker-0.0.0</span><ul class="links" id="page-menu"><li><a href="src/Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema2To3.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema2To3</p></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:migrateSchema2To3">migrateSchema2To3</a> :: <span class="keyword">forall</span> a m v. (<a href="../conduit-1.3.4.2/Conduit.html#t:MonadUnliftIO" title="Conduit">MonadUnliftIO</a> m, <a href="../unison-core1-0.0.0/Unison-Var.html#t:Var" title="Unison.Var">Var</a> v) =&gt; <a href="../unison-codebase-sqlite-0.0.0/U-Codebase-Sqlite-Connection.html#t:Connection" title="U.Codebase.Sqlite.Connection">Connection</a> -&gt; <a href="Unison-Codebase-Type.html#t:Codebase" title="Unison.Codebase.Type">Codebase</a> m v a -&gt; m (<a href="../base-4.14.3.0/Data-Either.html#t:Either" title="Data.Either">Either</a> <a href="Unison-Codebase-SqliteCodebase-Migrations-Errors.html#t:MigrationError" title="Unison.Codebase.SqliteCodebase.Migrations.Errors">MigrationError</a> ())</li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:migrateSchema2To3" class="def">migrateSchema2To3</a> :: <span class="keyword">forall</span> a m v. (<a href="../conduit-1.3.4.2/Conduit.html#t:MonadUnliftIO" title="Conduit">MonadUnliftIO</a> m, <a href="../unison-core1-0.0.0/Unison-Var.html#t:Var" title="Unison.Var">Var</a> v) =&gt; <a href="../unison-codebase-sqlite-0.0.0/U-Codebase-Sqlite-Connection.html#t:Connection" title="U.Codebase.Sqlite.Connection">Connection</a> -&gt; <a href="Unison-Codebase-Type.html#t:Codebase" title="Unison.Codebase.Type">Codebase</a> m v a -&gt; m (<a href="../base-4.14.3.0/Data-Either.html#t:Either" title="Data.Either">Either</a> <a href="Unison-Codebase-SqliteCodebase-Migrations-Errors.html#t:MigrationError" title="Unison.Codebase.SqliteCodebase.Migrations.Errors">MigrationError</a> ()) <a href="src/Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema2To3.html#migrateSchema2To3" class="link">Source</a> <a href="#v:migrateSchema2To3" class="selflink">#</a></p><div class="doc"><p>The 1 to 2 migration kept around hash objects of hash version 1, unfortunately this
 caused an issue:</p><p>The migration would detect causals whose value hash did not have a corresponding branch
 object, this was caused by a race-condition in sync which could end up in a partial sync.
 When a branch object was determined to be missing, the migration would replace it with the
 empty branch. This worked well, but led to a situation where related parent or successors
 of that causal would have their hash objects mapped to the new v2 object which contained
 the empty branch in place of missing branches. This is fine, but, if a different codebase
 migrated the same branch and wasn't missing the branch in question it would migrate
 successfully and each database now have the same v1 hash object mapped to two distinct v2
 objects, which rightfully causes a crash when syncing.</p><p>This migration drops all the v1 hash objects to avoid this issue, since these hash objects
 weren't being used for anything anyways.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.24.2</p></div></body></html>